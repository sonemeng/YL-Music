<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA è°ƒè¯•é¡µé¢</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: white;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        .success { background: rgba(76, 175, 80, 0.1); border-color: #4CAF50; }
        .error { background: rgba(244, 67, 54, 0.1); border-color: #f44336; }
        .warning { background: rgba(255, 193, 7, 0.1); border-color: #FFC107; }
        .info { background: rgba(33, 150, 243, 0.1); border-color: #2196F3; }
        pre {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ PWA åŠŸèƒ½è°ƒè¯•</h1>
    
    <div id="results"></div>
    
    <h2>ğŸ§ª æ‰‹åŠ¨æµ‹è¯•</h2>
    <button onclick="testManifest()">æµ‹è¯• Manifest</button>
    <button onclick="testServiceWorker()">æµ‹è¯• Service Worker</button>
    <button onclick="testInstallPrompt()">æµ‹è¯•å®‰è£…æç¤º</button>
    <button onclick="clearCache()">æ¸…é™¤ç¼“å­˜</button>
    
    <script>
        const results = document.getElementById('results');
        
        function addResult(type, title, content) {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${title}</strong><br>${content}`;
            results.appendChild(div);
        }
        
        // è‡ªåŠ¨æ£€æµ‹PWAåŠŸèƒ½
        async function checkPWAFeatures() {
            addResult('info', 'ğŸš€ å¼€å§‹PWAåŠŸèƒ½æ£€æµ‹', 'æ­£åœ¨æ£€æŸ¥å„é¡¹PWAåŠŸèƒ½...');
            
            // 1. æ£€æŸ¥ Manifest
            try {
                const response = await fetch('/manifest.json');
                if (response.ok) {
                    const manifest = await response.json();
                    addResult('success', 'âœ… Manifest æ–‡ä»¶', `æˆåŠŸåŠ è½½: ${manifest.name}`);
                    console.log('Manifest:', manifest);
                } else {
                    addResult('error', 'âŒ Manifest æ–‡ä»¶', `HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                addResult('error', 'âŒ Manifest æ–‡ä»¶', `åŠ è½½å¤±è´¥: ${error.message}`);
            }
            
            // 2. æ£€æŸ¥ Service Worker æ”¯æŒ
            if ('serviceWorker' in navigator) {
                addResult('success', 'âœ… Service Worker æ”¯æŒ', 'æµè§ˆå™¨æ”¯æŒ Service Worker');
                
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    addResult('success', 'âœ… Service Worker æ³¨å†Œ', `ä½œç”¨åŸŸ: ${registration.scope}`);
                    
                    // æ£€æŸ¥ Service Worker çŠ¶æ€
                    if (registration.active) {
                        addResult('success', 'âœ… Service Worker æ¿€æ´»', 'å·²æ¿€æ´»å¹¶è¿è¡Œ');
                    } else if (registration.installing) {
                        addResult('warning', 'â³ Service Worker å®‰è£…ä¸­', 'æ­£åœ¨å®‰è£…...');
                    } else if (registration.waiting) {
                        addResult('warning', 'â³ Service Worker ç­‰å¾…ä¸­', 'ç­‰å¾…æ¿€æ´»...');
                    }
                } catch (error) {
                    addResult('error', 'âŒ Service Worker æ³¨å†Œå¤±è´¥', error.message);
                }
            } else {
                addResult('error', 'âŒ Service Worker ä¸æ”¯æŒ', 'æµè§ˆå™¨ä¸æ”¯æŒ Service Worker');
            }
            
            // 3. æ£€æŸ¥å®‰è£…æç¤ºæ”¯æŒ
            if ('BeforeInstallPromptEvent' in window) {
                addResult('success', 'âœ… å®‰è£…æç¤ºæ”¯æŒ', 'æµè§ˆå™¨æ”¯æŒ PWA å®‰è£…æç¤º');
            } else {
                addResult('warning', 'âš ï¸ å®‰è£…æç¤º', 'æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒå®‰è£…æç¤ºï¼ˆSafari/Firefox ä½¿ç”¨å…¶ä»–æ–¹å¼ï¼‰');
            }
            
            // 4. æ£€æŸ¥åª’ä½“ä¼šè¯API
            if ('mediaSession' in navigator) {
                addResult('success', 'âœ… åª’ä½“ä¼šè¯API', 'æ”¯æŒç³»ç»Ÿåª’ä½“æ§åˆ¶');
            } else {
                addResult('warning', 'âš ï¸ åª’ä½“ä¼šè¯API', 'ä¸æ”¯æŒç³»ç»Ÿåª’ä½“æ§åˆ¶');
            }
            
            // 5. æ£€æŸ¥ç¼“å­˜API
            if ('caches' in window) {
                addResult('success', 'âœ… ç¼“å­˜API', 'æ”¯æŒç¦»çº¿ç¼“å­˜');
                
                try {
                    const cacheNames = await caches.keys();
                    if (cacheNames.length > 0) {
                        addResult('info', 'ğŸ“¦ ç°æœ‰ç¼“å­˜', `å‘ç° ${cacheNames.length} ä¸ªç¼“å­˜: ${cacheNames.join(', ')}`);
                    } else {
                        addResult('info', 'ğŸ“¦ ç¼“å­˜çŠ¶æ€', 'æš‚æ— ç¼“å­˜æ•°æ®');
                    }
                } catch (error) {
                    addResult('error', 'âŒ ç¼“å­˜æ£€æŸ¥å¤±è´¥', error.message);
                }
            } else {
                addResult('error', 'âŒ ç¼“å­˜API', 'ä¸æ”¯æŒç¼“å­˜API');
            }
            
            // 6. æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            if ('onLine' in navigator) {
                const status = navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿';
                const type = navigator.onLine ? 'success' : 'warning';
                addResult(type, 'ğŸŒ ç½‘ç»œçŠ¶æ€', `å½“å‰çŠ¶æ€: ${status}`);
            }
            
            // 7. æ£€æŸ¥æ˜¾ç¤ºæ¨¡å¼
            const displayMode = window.matchMedia('(display-mode: standalone)').matches ? 'PWAç‹¬ç«‹æ¨¡å¼' : 
                               window.matchMedia('(display-mode: minimal-ui)').matches ? 'æœ€å°UIæ¨¡å¼' : 
                               window.matchMedia('(display-mode: fullscreen)').matches ? 'å…¨å±æ¨¡å¼' : 'æµè§ˆå™¨æ¨¡å¼';
            
            const type = displayMode === 'PWAç‹¬ç«‹æ¨¡å¼' ? 'success' : 'info';
            addResult(type, 'ğŸ“± æ˜¾ç¤ºæ¨¡å¼', displayMode);
            
            // 8. æ£€æŸ¥HTTPS
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
            if (isSecure) {
                addResult('success', 'ğŸ”’ å®‰å…¨è¿æ¥', 'HTTPS æˆ– localhost');
            } else {
                addResult('error', 'âŒ ä¸å®‰å…¨è¿æ¥', 'PWA éœ€è¦ HTTPS è¿æ¥');
            }
        }
        
        // æ‰‹åŠ¨æµ‹è¯•å‡½æ•°
        async function testManifest() {
            try {
                const response = await fetch('/manifest.json');
                const manifest = await response.json();
                addResult('info', 'ğŸ“‹ Manifest å†…å®¹', `<pre>${JSON.stringify(manifest, null, 2)}</pre>`);
            } catch (error) {
                addResult('error', 'âŒ Manifest æµ‹è¯•å¤±è´¥', error.message);
            }
        }
        
        async function testServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    addResult('info', 'ğŸ”§ Service Worker çŠ¶æ€', 
                        `æ³¨å†Œæ•°é‡: ${registrations.length}<br>` +
                        registrations.map(reg => `ä½œç”¨åŸŸ: ${reg.scope}, çŠ¶æ€: ${reg.active ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}`).join('<br>')
                    );
                } catch (error) {
                    addResult('error', 'âŒ Service Worker æµ‹è¯•å¤±è´¥', error.message);
                }
            }
        }
        
        function testInstallPrompt() {
            addResult('info', 'ğŸ’¡ å®‰è£…æç¤ºæµ‹è¯•', 'è¯·æ£€æŸ¥åœ°å€æ æ˜¯å¦æœ‰å®‰è£…å›¾æ ‡ï¼Œæˆ–ç­‰å¾…å®‰è£…æ¨ªå¹…å‡ºç°');
        }
        
        async function clearCache() {
            try {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                addResult('success', 'ğŸ—‘ï¸ ç¼“å­˜æ¸…é™¤', `å·²æ¸…é™¤ ${cacheNames.length} ä¸ªç¼“å­˜`);
                
                // é‡æ–°æ³¨å†Œ Service Worker
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map(reg => reg.unregister()));
                    addResult('info', 'ğŸ”„ Service Worker', 'å·²æ³¨é”€ï¼Œé¡µé¢åˆ·æ–°åå°†é‡æ–°æ³¨å†Œ');
                }
            } catch (error) {
                addResult('error', 'âŒ æ¸…é™¤å¤±è´¥', error.message);
            }
        }
        
        // ç›‘å¬å®‰è£…æç¤ºäº‹ä»¶
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            addResult('success', 'ğŸ‰ å®‰è£…æç¤ºå¯ç”¨', 'æ£€æµ‹åˆ°å®‰è£…æç¤ºäº‹ä»¶');
        });
        
        // ç›‘å¬åº”ç”¨å®‰è£…äº‹ä»¶
        window.addEventListener('appinstalled', (e) => {
            addResult('success', 'ğŸ‰ åº”ç”¨å·²å®‰è£…', 'PWA å®‰è£…æˆåŠŸï¼');
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æµ‹
        document.addEventListener('DOMContentLoaded', checkPWAFeatures);
    </script>
</body>
</html>